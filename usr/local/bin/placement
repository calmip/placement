#! /bin/bash

# Version de Python: nous avons besoin de Python 2.7, ce qui nécessite un module sur eos
# (pas eosmesca1)
version=$(python --version 2>&1)
if [[ "$version" =~ "2.6" ]]
then
	module purge >/dev/null 2>&1
	module load python >/dev/null 2>&1
fi

# pythonpath 
dir=$(dirname $0)
export PYTHONPATH=$(cd $dir;cd ../lib/placement; pwd -P)

# placementetc
# You'll find configuration files in this directory
export PLACEMENTETC=$(cd $dir;cd ../etc/placement; pwd -P)

# Name of the python script
placement="python $0.py"

# verbose !
if [[ "$*" =~ "--verb" ]]
then
	verb=1
else
	verb=0
fi

# --checkme => We check the job in state "RUNNING"
if [[ $1 == "--checkme" ]]
then
	shift
	job_id=$(squeue --noheader -u $(whoami) -t R -o %A|head -1)
	if [[ $job_id == "" ]]
	then
		echo "ERROR - --checkme is a nonsense if you do not have any running job !"
		exit 1
	fi
	if [[ $verb == 1 ]]
	then
		echo "OPTION --checkme: Now checking job $job_id for user $(whoami)"
	fi
	set -- $* "--check=$(whoami)"
fi
	
# --job_id 12345 => On checke le job 12345
if [[ $1 == "--jobid" ]]
then
	shift
	job_id=$1
	shift
fi

# --host taratata => On checke le host taratata
if [[ $1 == "--host" ]]
then
	shift
	host=$1
	shift
fi

# $job_id est spécifié => On va checker sur les nœuds
if [[ $job_id != "" ]]
then
    PN=$( squeue -j $job_id --noheader -o "%.9P@%.16R@%.8u" )
	if [[ $? != 0 || $PN == "" ]]
    then
		echo "ERROR - Bad jobid ! ($job_id)"
		exit 1
	fi

	[[ $PN =~ (.*)@(.*)@(.*) ]]

	# P = partition, N = nodeset
	P=${BASH_REMATCH[1]}
	N=${BASH_REMATCH[2]}
	U=${BASH_REMATCH[3]}

	if [[ $N =~ \(.*\) ]] 
	then
       echo "ERROR - Bad jobid ! ($job_id)"
	   exit 1
	fi

	for n in $(nodeset -e $N)
	do
		if [[ $verb == 1 ]]
		then
			echo "$n: CALLING $0 --check $U $*"
		fi
		ssh $n export PLACEMENT_PARTITION=\"$P\" \; $0 --check $U $*
	done

# --host: Sending the command on the requested host
elif [[ $host != "" ]]
then
	# Détecter la partition, à condition qu'un job soit exécuté sur le host !
	# Et sinon la commande n'a aucun intérêt
	P=$(squeue --noheader -w $host -o "%.9P"|head -1)
	if [[ $P == "" ]]
	then
		echo "OUPS - No job on $host yet"
		exit 1
	fi
	if [[ $verb == 1 ]]
	then
		echo "$host: CALLING $0 $*"
	fi

	ssh $host export PLACEMENT_PARTITION=\"$P\" \;  $0 $*

# Pas de $job_id: on passe les switches à placement.py
else
	if [[ "$*" =~ --jobid ]]
	then
       echo "Usage: placement --jobid 12345 --check=EXE [--ascii] [--taskset]"
	   exit 1
	else
	   exec $placement $*
	fi
fi
