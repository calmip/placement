#! /bin/bash

dir=$(dirname $0)

export PYTHONPATH=$(cd $dir;cd ../lib/placement; pwd -P)

placement="$0.py"

if [[ $1 == "--jobid" ]]
then
	shift
	job_id=$1
	shift
    PN=$( squeue -j $job_id --noheader -o "%.9P@%.16R" )
	if [[ $? != 0 ]]
    then
		echo "ERREUR - Mauvais jobid ! ($job_id)"
		exit 1
	fi

	[[ $PN =~ (.*)@(.*) ]]

	# P = partition, N = nodeset
	P=${BASH_REMATCH[1]}
	N=${BASH_REMATCH[2]}

	if [[ $N =~ \(.*\) ]] 
	then
       echo "ERREUR - Mauvais jobid ! ($job_id)"
	   exit 1
	fi

	for n in $(nodeset -e $N)
	do
		ssh $n export PLACEMENT_ARCHI=\"$P\" \; $0 $*
	done
else
	if [[ "$*" =~ --jobid ]]
	then
       echo "Usage: placement --jobid 12345 --check=EXE [--ascii] [--taskset]"
	   exit 1
	else
	   exec $placement $*
	fi
fi

